name: Deploy API Gateway

on:
  push:
    branches:
      - qa-environment
      - dev-environment
    paths:
      - 'services/microservices/api-gateway/**'

env:
  FULL_IMAGE_NAME: api-gateway:${{ github.run_id }}

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:

      - name: Check out code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: docker build -t $FULL_IMAGE_NAME -f services/microservices/api-gateway/Dockerfile .

      - name: Save Docker Image
        run: docker save -o api-gateway.tar $FULL_IMAGE_NAME

      - name: Copy Image to Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          source: "api-gateway.tar"
          target: "/home/azureuser/"

      - name: Load and Deploy API Gateway
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          script: |
            cd /home/azureuser
            sudo docker load -i api-gateway.tar
            rm api-gateway.tar
            FULL_IMAGE_NAME=${{ env.FULL_IMAGE_NAME }} docker compose -f docker-compose.yml up -d api-gateway
            sudo docker image prune -f
